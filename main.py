# main.py

import json
import re
import os
from telebot import TeleBot

# ============================
# ฑ) ุชูุธูุงุช ุงููู
# ============================
# ุจุฑุง ุงููุชุ ุชูุตู ูโุดูุฏ ุชูฺฉู ุชูฺฏุฑุงู ุฑุง ุจู ุตูุฑุช ูุชุบุฑ ูุญุท ุฐุฎุฑู ฺฉูุฏ.
# ุฏุฑ ููฺฉุงู ูโุชูุงูุฏ ูุงู .env ุจุณุงุฒุฏ ู BOT_TOKEN=your_token ุฑุง ุฏุงุฎู ุขู ูุฑุงุฑ ุฏูุฏุ
# ู ุณูพุณ ุงุฒ python-dotenv ุจุฑุง ุจุงุฑฺฏุฐุงุฑ ุงุณุชูุงุฏู ฺฉูุฏ.
#
# ุงูุง ุฏุฑ ุงู ูุซุงู ุณุงุฏูุ ูุฑุถ ูโฺฉูู ูุชุบุฑ ูุญุท ุชุนุฑู ุดุฏู ุงุณุช:
BOT_TOKEN = ("7693573912:AAH5GlCeMvYolHuq8BckIEKgbDogcg6sldM")  # ุงฺฏุฑ ุฏุฑ ูุชุบุฑ ูุญุท ูุจุงุดุฏุ ุชูฺฉู ูุณุชูู ูโุขุฏ

# ูุณุฑ ูุงู JSON (ุฏุฑ ููุงู ูุณุฑ ฺฉู main.py ูุฑุงุฑ ุฏุงุฑุฏ)
JSON_PATH = "playlist.json"

# ุงุฌุงุฏ ุดุก ุฑุจุงุช
bot = TeleBot(BOT_TOKEN, parse_mode=None)


# ============================
# ฒ) ุชุงุจุน ุจุงุฑฺฏุฐุงุฑ/ุฐุฎุฑูโุณุงุฒ JSON
# ============================
def load_playlist():
    """
    ูุงู playlist.json ุฑุง ุจุงุฒ ูโฺฉูุฏ ู ุจู ุตูุฑุช ูุณุช ูพุงุชูู ุจุฑูโฺฏุฑุฏุงูุฏ.
    ุงฺฏุฑ ูุงู ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏ ุง ุฎุทุง ุฏุฑ ุฎูุงูุฏู ุจุงุดุฏุ ฺฉ ูุณุช ุฎุงู ุจุงุฒูโฺฏุฑุฏุงูุฏ.
    """
    try:
        with open(JSON_PATH, "r", encoding="utf-8") as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        return []


def save_playlist(playlist: list):
    """
    ูุณุช ูพูโูุณุช ุฑุง (ฺฉู ุดุงูู ุฏฺฉุดูุฑโูุง ุขููฺฏ ุงุณุช) ุฏุฑ ูุงู JSON ุฐุฎุฑู ูโฺฉูุฏ.
    """
    with open(JSON_PATH, "w", encoding="utf-8") as f:
        json.dump(playlist, f, indent=4, ensure_ascii=False)


# ============================
# ณ) ููุฏูุฑ ุฑุจุงุช ุจุฑุง ูพุงูโูุง ูุชู
# ============================
@bot.message_handler(commands=["start", "help"])
def send_welcome(message):
    """
    ููุช ฺฉุงุฑุจุฑ ุฏุณุชูุฑ /start ุง /help ูโูุฑุณุชุฏุ ูพุงู ุฑุงูููุง ููุงุด ุฏุงุฏู ูโุดูุฏ.
    """
    tip = (
        "ุณูุงู ๐\n\n"
        "ุจุฑุง ุงูุฒูุฏู ุขููฺฏุ ูพุงู ุฎูุฏ ุฑุง ุฏุฑ ุงู ูุฑูุช ุจูุฑุณุชุฏ:\n"
        "<ูุงู ุขููฺฏ> ุงุฒ <ูุงู ุฎูุงููุฏู> <ููฺฉ ุขููฺฏ>\n\n"
        "ูุซุงู:\n"
        "ุฑุฏูพุง ุงุฒ ุญุตู https://example.com/song.mp3"
    )
    bot.reply_to(message, tip)


@bot.message_handler(func=lambda msg: True, content_types=["text"])
def handle_text_message(message):
    """
    ุงู ุชุงุจุน ุจุฑุง ูุฑ ูพุงู ูุชู ูุฑุงุฎูุงู ูโุดูุฏ:
    1. ูุชู ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ุฏููุงู ฺฉ URL ุฏุงุดุชู ุจุงุดุฏ.
    2. ุจุฎุด ูุจู ุงุฒ ููฺฉ ุฑุง ุจุง ' ุงุฒ ' ุชูฺฉฺฉ ูโฺฉูุฏ ุชุง ูุงู ุขููฺฏ ู ูุงู ุฎูุงููุฏู ุงุณุชุฎุฑุงุฌ ุดูุฏ.
    3. ุฏุฑ ุตูุฑุช ููููุชุ ุขููฺฏ ุฌุฏุฏ ุฑุง ุฏุฑ playlist.json ุฐุฎุฑู ูโฺฉูุฏ.
    4. ุฏุฑ ุตูุฑุช ุฎุทุงุ ูพุงู ููุงุณุจ ุจู ฺฉุงุฑุจุฑ ุงุฑุณุงู ูโฺฉูุฏ.
    """
    text = message.text.strip()

    try:
        # ุงุจุชุฏุง ฺฺฉ ูโฺฉูู ฺฉู ุญุฏุงูู ฺฉ URL (http/https) ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ
        # ู ุฏููุงู ุฏุฑ ุงูุชูุง ูุชู ฺฉ URL ูุฑุงุฑ ุฏุงุฑุฏ.
        pattern = r"^(.+)\s+(https?://\S+)$"
        m = re.match(pattern, text)
        if not m:
            raise ValueError("ูุฑูุช ูพุงู ุตุญุญ ูุณุช. ุงุฒ ุงูฺฏู ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:\n"
                             "ูุงู ุขููฺฏ ุงุฒ ูุงู ุฎูุงููุฏู ููฺฉ ุขููฺฏ")

        # ุจุฎุด ูุจู ุงุฒ ููฺฉ
        name_artist_part = m.group(1).strip()
        # ุฎูุฏ ููฺฉ
        url_part = m.group(2).strip()

        # ุงุฒ ฺฉููู ' ุงุฒ ' ุจุฑุง ุฌุฏุงุณุงุฒ ูุงู ุขููฺฏ ู ุฎูุงููุฏู ุงุณุชูุงุฏู ูโฺฉูู
        if " ุงุฒ " not in name_artist_part:
            raise ValueError("ูุฑูุช ูพุงู ุฏุฑุณุช ูุณุช. ุจู ูุงู ุขููฺฏ ู ุฎูุงููุฏู ฺฉููู ' ุงุฒ ' ุจุงุดุฏ.")

        name_part, artist_part = name_artist_part.split(" ุงุฒ ", 1)
        name_part = name_part.strip()
        artist_part = artist_part.strip()

        # ุงฺฏุฑ ูุฑ ฺฉุฏุงู ุฎุงู ุจุงุดุฏุ ุฎุทุง ุจุฏู
        if not name_part or not artist_part:
            raise ValueError("ูุงู ุขููฺฏ ุง ูุงู ุฎูุงููุฏู ููโุชูุงูุฏ ุฎุงู ุจุงุดุฏ.")

        # ุจุงุฑฺฏุฐุงุฑ playlist ูุนู ุงุฒ JSON
        playlist = load_playlist()

        # ุงุฌุงุฏ ุณุงุฎุชุงุฑ ุฏฺฉุดูุฑ ุฌุฏุฏ ุจุฑุง ุขููฺฏ
        new_song = {
            "name": name_part,
            "artist": artist_part,
            "url": url_part
        }

        # ุงุถุงูู ฺฉุฑุฏู ุขููฺฏ ุฌุฏุฏ ุจู ูุณุช ู ุฐุฎุฑู ูุฌุฏุฏ
        playlist.append(new_song)
        save_playlist(playlist)

        # ูพุงุณุฎ ููููุช
        bot.reply_to(message, f"ุขููฺฏ ยซ{name_part}ยป ุงุฒ ยซ{artist_part}ยป ุจุง ููููุช ุงุถุงูู ุดุฏ โ")
    except Exception as e:
        # ุงุฑุณุงู ูพุงู ุฎุทุง ุจู ฺฉุงุฑุจุฑ
        bot.reply_to(message, f"โ ุฎุทุง: {e}")


# ============================
# ด) ุงุฌุฑุง ุฑุจุงุช (Polling)
# ============================
if __name__ == "__main__":
    print("๐ ุฑุจุงุช ุฏุฑ ุญุงู ุงุฌุฑุงุณุช...")
    bot.infinity_polling(timeout=10, long_polling_timeout=5)
